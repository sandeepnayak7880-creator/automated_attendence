<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rural School Attendance System</title>

    <style>
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Background color tokens (Light Mode) */
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);

            /* Semantic Color Tokens (Light Mode) */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

            /* Common style patterns */
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --status-bg-opacity: 0.15;
            --status-border-opacity: 0.25;

            /* RGB versions for opacity control */
            --color-success-rgb: 33, 128, 141;
            --color-error-rgb: 192, 21, 47;
            --color-warning-rgb: 168, 75, 47;
            --color-info-rgb: 98, 108, 113;

            /* Typography */
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;

            /* Spacing */
            --space-0: 0;
            --space-1: 1px;
            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

            /* Animation */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Base styles */
        html {
            font-size: var(--font-size-base);
            font-family: var(--font-family-base);
            line-height: var(--line-height-normal);
            color: var(--color-text);
            background-color: var(--color-background);
            -webkit-font-smoothing: antialiased;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        *, *::before, *::after {
            box-sizing: inherit;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-16);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-12) var(--space-20);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 500;
            line-height: 1.5;
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            border: none;
            text-decoration: none;
        }

        .btn--primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
            background: var(--color-primary-hover);
        }

        .btn--secondary {
            background: var(--color-secondary);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn--secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn--success {
            background: var(--color-success);
            color: white;
        }

        .btn--danger {
            background: var(--color-error);
            color: white;
        }

        .btn--large {
            padding: var(--space-16) var(--space-24);
            font-size: var(--font-size-lg);
        }

        .form-control {
            display: block;
            width: 100%;
            padding: var(--space-12);
            font-size: var(--font-size-base);
            color: var(--color-text);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            transition: border-color var(--duration-fast) var(--ease-standard);
        }

        .form-control:focus {
            border-color: var(--color-primary);
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .form-group {
            margin-bottom: var(--space-16);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-16);
        }

        .nav {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-16) 0;
        }

        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-16);
        }

        .nav-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .nav-links {
            display: flex;
            gap: var(--space-16);
        }

        .nav-link {
            padding: var(--space-8) var(--space-16);
            color: var(--color-text-secondary);
            text-decoration: none;
            border-radius: var(--radius-base);
            transition: all var(--duration-fast);
        }

        .nav-link:hover, .nav-link.active {
            color: var(--color-primary);
            background: var(--color-bg-1);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .status {
            display: inline-flex;
            align-items: center;
            padding: var(--space-6) var(--space-12);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .status--success {
            background: rgba(var(--color-success-rgb), 0.15);
            color: var(--color-success);
            border: 1px solid rgba(var(--color-success-rgb), 0.25);
        }

        .status--error {
            background: rgba(var(--color-error-rgb), 0.15);
            color: var(--color-error);
            border: 1px solid rgba(var(--color-error-rgb), 0.25);
        }

        .status--warning {
            background: rgba(var(--color-warning-rgb), 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(var(--color-warning-rgb), 0.25);
        }

        .grid {
            display: grid;
            gap: var(--space-16);
        }

        .grid--2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid--3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-8 {
            gap: var(--space-8);
        }

        .gap-16 {
            gap: var(--space-16);
        }

        .text-center {
            text-align: center;
        }

        .mb-16 {
            margin-bottom: var(--space-16);
        }

        .mt-16 {
            margin-top: var(--space-16);
        }

        .hidden {
            display: none !important;
        }

        /* Camera specific styles */
        .camera-container {
            position: relative;
            max-width: 400px;
            margin: 0 auto;
        }

        .camera-feed {
            width: 100%;
            border-radius: var(--radius-lg);
            border: 2px solid var(--color-border);
        }

        .camera-controls {
            margin-top: var(--space-16);
            text-align: center;
        }

        .student-photo {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-base);
            object-fit: cover;
            border: 2px solid var(--color-border);
        }

        .attendance-photo {
            width: 120px;
            height: 120px;
            border-radius: var(--radius-base);
            object-fit: cover;
            border: 2px solid var(--color-border);
        }

        .comparison-container {
            display: flex;
            gap: var(--space-20);
            align-items: center;
            justify-content: center;
            margin: var(--space-20) 0;
        }

        .photo-label {
            text-align: center;
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-8);
        }

        .student-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-16);
        }

        .student-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            text-align: center;
        }

        .student-card img {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-base);
            object-fit: cover;
            margin-bottom: var(--space-8);
        }

        .alert {
            padding: var(--space-12) var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }

        .alert--success {
            background: rgba(var(--color-success-rgb), 0.1);
            color: var(--color-success);
            border: 1px solid rgba(var(--color-success-rgb), 0.2);
        }

        .alert--error {
            background: rgba(var(--color-error-rgb), 0.1);
            color: var(--color-error);
            border: 1px solid rgba(var(--color-error-rgb), 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            text-align: center;
        }

        .stat-number {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-4);
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-background);
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-32);
            box-shadow: var(--shadow-lg);
        }

        .login-title {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            text-align: center;
            margin-bottom: var(--space-32);
            color: var(--color-primary);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-16);
        }

        .table th,
        .table td {
            padding: var(--space-12);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .table th {
            background: var(--color-bg-1);
            font-weight: var(--font-weight-medium);
        }

        .time-display {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            text-align: center;
            margin-bottom: var(--space-16);
        }

        .attendance-window {
            background: var(--color-bg-3);
            border: 1px solid rgba(var(--color-success-rgb), 0.3);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            text-align: center;
            margin-bottom: var(--space-20);
        }

        .attendance-window.closed {
            background: var(--color-bg-4);
            border-color: rgba(var(--color-error-rgb), 0.3);
        }

        /* Face detection overlay styles */
        .face-detection-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .face-box {
            position: absolute;
            border: 3px solid var(--color-primary);
            border-radius: var(--radius-sm);
            background: rgba(var(--color-primary-rgb, 33, 128, 141), 0.1);
        }

        .face-label {
            position: absolute;
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            top: -30px;
            left: 0;
        }

        .recognition-status {
            position: absolute;
            top: var(--space-16);
            left: var(--space-16);
            right: var(--space-16);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: var(--space-12);
            border-radius: var(--radius-base);
            text-align: center;
            font-weight: var(--font-weight-medium);
        }

        .attendance-success {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-success);
            color: white;
            padding: var(--space-24);
            border-radius: var(--radius-lg);
            text-align: center;
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            opacity: 0;
            transition: opacity var(--duration-normal);
        }

        .attendance-success.show {
            opacity: 1;
        }

        .model-loading {
            background: var(--color-bg-2);
            border: 1px solid rgba(var(--color-warning-rgb), 0.3);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            text-align: center;
            margin-bottom: var(--space-16);
        }

        .confidence-meter {
            width: 100%;
            height: 20px;
            background: var(--color-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin: var(--space-8) 0;
        }

        .confidence-fill {
            height: 100%;
            background: var(--color-success);
            transition: width var(--duration-fast);
        }

        .auto-attendance-controls {
            display: flex;
            gap: var(--space-12);
            align-items: center;
            justify-content: center;
            margin: var(--space-16) 0;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: var(--space-8);
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-base);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }

        .status-indicator.scanning {
            background: var(--color-bg-1);
            color: var(--color-primary);
        }

        .status-indicator.processing {
            background: var(--color-bg-2);
            color: var(--color-warning);
        }

        .status-indicator.stopped {
            background: var(--color-bg-4);
            color: var(--color-error);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .nav-content {
                flex-direction: column;
                gap: var(--space-16);
            }

            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }

            .comparison-container {
                flex-direction: column;
            }

            .grid--2, .grid--3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-card">
                <h1 class="login-title">School Attendance System</h1>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" value="admin" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="password" class="form-control" value="password" required>
                    </div>
                    <div id="loginError" class="alert alert--error hidden"></div>
                    <button type="submit" class="btn btn--primary btn--large" style="width: 100%;">Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="page">
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-content">
                <h1 class="nav-title">Attendance System</h1>
                <div class="nav-links">
                    <a href="#" class="nav-link" onclick="showPage('dashboard')">Dashboard</a>
                    <a href="#" class="nav-link" onclick="showPage('students')">Students</a>
                    <a href="#" class="nav-link" onclick="showPage('attendance')">Attendance</a>
                    <a href="#" class="nav-link" onclick="showPage('reports')">Reports</a>
                    <a href="#" class="nav-link" onclick="showPage('settings')">Settings</a>
                    <a href="#" class="nav-link" onclick="logout()">Logout</a>
                </div>
            </div>
        </nav>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="page active">
            <div class="container">
                <h2>Dashboard</h2>
                <div class="time-display" id="currentTime"></div>
                
                <div class="attendance-window" id="attendanceWindow">
                    <h3>Attendance Window Status</h3>
                    <p id="windowStatus">Checking...</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div class="stat-label">Total Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="presentToday">0</div>
                        <div class="stat-label">Present Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="absentToday">0</div>
                        <div class="stat-label">Absent Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="attendanceRate">0%</div>
                        <div class="stat-label">Attendance Rate</div>
                    </div>
                </div>

                <div class="grid grid--2">
                    <div class="card">
                        <h3>Quick Actions</h3>
                        <div class="flex flex-col gap-8">
                            <button class="btn btn--primary" onclick="showPage('students')">Manage Students</button>
                            <button class="btn btn--success" onclick="showPage('attendance')">Mark Attendance</button>
                            <button class="btn btn--secondary" onclick="showPage('reports')">Generate Reports</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Today's Summary</h3>
                        <div id="todaySummary">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Page -->
        <div id="studentsPage" class="page">
            <div class="container">
                <div class="flex justify-between items-center mb-16">
                    <h2>Student Management</h2>
                    <button class="btn btn--primary" onclick="showAddStudent()">Add Student</button>
                </div>

                <!-- Add Student Form -->
                <div id="addStudentForm" class="card hidden">
                    <h3>Add New Student</h3>
                    <div class="grid grid--2">
                        <div>
                            <div class="form-group">
                                <label class="form-label">Student ID</label>
                                <input type="text" id="studentId" class="form-control" placeholder="STU001" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" id="studentName" class="form-control" placeholder="Student Name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Class</label>
                                <input type="text" id="studentClass" class="form-control" placeholder="5th" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Roll Number</label>
                                <input type="text" id="rollNumber" class="form-control" placeholder="05" required>
                            </div>
                        </div>
                        <div>
                            <div class="camera-container">
                                <video id="studentCamera" class="camera-feed" autoplay muted></video>
                                <canvas id="studentCanvas" class="hidden"></canvas>
                                <canvas id="studentOverlay" class="face-detection-overlay"></canvas>
                                <div class="recognition-status" id="studentRecognitionStatus" style="display: none;">Initializing face detection...</div>
                                <div class="camera-controls">
                                    <button type="button" class="btn btn--secondary" onclick="startStudentCamera()">Start Camera</button>
                                    <button type="button" class="btn btn--primary" onclick="captureMultipleFacePhotos()">Capture Face Data (5 photos)</button>
                                    <button type="button" class="btn btn--success" onclick="saveStudent()" disabled id="saveStudentBtn">Save Student</button>
                                    <button type="button" class="btn btn--secondary" onclick="cancelAddStudent()">Cancel</button>
                                </div>
                                <div id="captureProgress" style="display: none; text-align: center; margin-top: 16px;">
                                    <p>Capturing face data: <span id="captureCount">0</span>/5</p>
                                    <div class="confidence-meter">
                                        <div class="confidence-fill" id="captureConfidence" style="width: 0%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="studentAlert" class="hidden"></div>
                </div>

                <!-- Students List -->
                <div class="student-list" id="studentsList"></div>
            </div>
        </div>

        <!-- Attendance Page -->
        <div id="attendancePage" class="page">
            <div class="container">
                <h2>Mark Attendance</h2>
                
                <div class="attendance-window" id="attendancePageWindow">
                    <h3>Attendance Window</h3>
                    <p id="attendancePageWindowStatus">Checking...</p>
                </div>

                <div class="model-loading" id="modelLoading" style="display: none;">
                    <h3>‚úì Face Recognition System Ready</h3>
                    <p>Canvas-based face recognition initialized successfully.</p>
                </div>

                <div class="card">
                    <h3>üîç Automatic Face Recognition Attendance</h3>
                    <div class="auto-attendance-controls">
                        <button class="btn btn--success" onclick="startAutoAttendance()" id="startAutoBtn">Start Auto Attendance</button>
                        <button class="btn btn--danger" onclick="stopAutoAttendance()" id="stopAutoBtn" disabled>Stop Auto Attendance</button>
                        <div class="status-indicator stopped" id="scanningStatus">
                            <span>‚óè</span> System Stopped
                        </div>
                    </div>
                    
                    <div class="camera-container" style="max-width: 100%; margin: 16px 0;">
                        <video id="attendanceCamera" class="camera-feed" autoplay muted style="width: 100%; max-width: 640px;"></video>
                        <canvas id="attendanceOverlay" class="face-detection-overlay"></canvas>
                    <canvas id="attendanceCanvas" class="hidden"></canvas>
                        <div class="recognition-status" id="attendanceRecognitionStatus" style="display: none;">Scanning for faces...</div>
                    </div>

                    <div class="grid grid--2" style="margin-top: 16px;">
                        <div>
                            <h4>Recognition Settings</h4>
                            <div class="form-group">
                                <label class="form-label">Confidence Threshold: <span id="confidenceValue">0.6</span></label>
                                <input type="range" id="confidenceSlider" min="0.3" max="0.8" step="0.1" value="0.6" class="form-control" oninput="updateConfidenceThreshold()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Processing Speed</label>
                                <select id="processingSpeed" class="form-control" onchange="updateProcessingSpeed()">
                                    <option value="2">Fast (every 2 frames)</option>
                                    <option value="3" selected>Normal (every 3 frames)</option>
                                    <option value="5">Slow (every 5 frames)</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <h4>Live Recognition Log</h4>
                            <div id="recognitionLog" style="height: 150px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: 12px; background: var(--color-surface);">
                                <p style="color: var(--color-text-secondary); text-align: center;">Start auto attendance to see recognition logs...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Manual Override</h3>
                    <div class="form-group">
                        <label class="form-label">Manually Select Student (if auto-recognition fails)</label>
                        <select id="studentSelect" class="form-control">
                            <option value="">Choose student...</option>
                        </select>
                    </div>
                    <div class="flex gap-8">
                        <button class="btn btn--success" onclick="markPresent()">Mark Present</button>
                        <button class="btn btn--danger" onclick="markAbsent()">Mark Absent</button>
                        <button class="btn btn--secondary" onclick="captureAttendancePhoto()">Capture Photo</button>
                    </div>
                    
                    <!-- Photo comparison container -->
                    <div id="comparisonContainer" class="comparison-container" style="display: none;">
                        <div>
                            <div class="photo-label">Registered Photo</div>
                            <img id="registeredPhoto" class="attendance-photo" alt="Registered photo">
                        </div>
                        <div>
                            <div class="photo-label">Current Photo</div>
                            <img id="currentPhoto" class="attendance-photo" alt="Current photo">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Today's Attendance</h3>
                    <table class="table" id="todayAttendanceTable">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="todayAttendanceBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Page -->
        <div id="reportsPage" class="page">
            <div class="container">
                <h2>Reports &amp; Export</h2>
                
                <div class="card">
                    <h3>Generate Report</h3>
                    <div class="grid grid--2">
                        <div class="form-group">
                            <label class="form-label">From Date</label>
                            <input type="date" id="fromDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">To Date</label>
                            <input type="date" id="toDate" class="form-control">
                        </div>
                    </div>
                    <button class="btn btn--primary" onclick="generateReport()">Generate Report</button>
                    <button class="btn btn--success" onclick="exportToCSV()">Export to CSV</button>
                </div>

                <div class="card">
                    <h3>Report Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="reportTotalDays">0</div>
                            <div class="stat-label">Total Days</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="reportTotalPresent">0</div>
                            <div class="stat-label">Total Present</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="reportTotalAbsent">0</div>
                            <div class="stat-label">Total Absent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="reportAttendanceRate">0%</div>
                            <div class="stat-label">Average Rate</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Detailed Report</h3>
                    <div id="reportTableContainer">
                        <p class="text-center">Generate a report to view detailed data.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="page">
            <div class="container">
                <h2>Settings</h2>
                
                <div class="grid grid--2">
                    <div class="card">
                        <h3>School Information</h3>
                        <div class="form-group">
                            <label class="form-label">School Name</label>
                            <input type="text" id="schoolName" class="form-control" value="Government Primary School Rampur">
                        </div>
                        <button class="btn btn--primary" onclick="saveSchoolSettings()">Save Settings</button>
                    </div>
                    
                    <div class="card">
                        <h3>Attendance Window</h3>
                        <div class="form-group">
                            <label class="form-label">Start Time</label>
                            <input type="time" id="attendanceStartTime" class="form-control" value="09:00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Time</label>
                            <input type="time" id="attendanceEndTime" class="form-control" value="09:30">
                        </div>
                        <button class="btn btn--primary" onclick="saveTimeSettings()">Save Time Settings</button>
                    </div>
                </div>

                <div class="grid grid--2">
                    <div class="card">
                        <h3>Data Management</h3>
                        <div class="flex flex-col gap-8">
                            <button class="btn btn--secondary" onclick="backupData()">Backup All Data</button>
                            <button class="btn btn--secondary" onclick="importData()">Import Data</button>
                            <button class="btn btn--danger" onclick="clearAllData()">Clear All Data</button>
                        </div>
                        <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImportFile(event)">
                    </div>
                    
                    <div class="card">
                        <h3>System Information</h3>
                        <p><strong>Version:</strong> 1.0.0</p>
                        <p><strong>Last Backup:</strong> <span id="lastBackup">Never</span></p>
                        <p><strong>Total Students:</strong> <span id="settingsTotalStudents">0</span></p>
                        <p><strong>Total Attendance Records:</strong> <span id="totalAttendanceRecords">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success notification overlay -->
    <div id="attendanceSuccess" class="attendance-success">
        <div style="font-size: 48px; margin-bottom: 16px;">‚úì</div>
        <div id="successMessage">Attendance Marked Successfully!</div>
        <div id="successStudent" style="margin-top: 8px; font-size: 16px; opacity: 0.9;"></div>
    </div>

    <!-- Firebase v9+ Modular SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, doc, setDoc, Timestamp, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD5ryTMGrud4Wec2cZkbovqMRRDB2fMKhk",
            authDomain: "automated-attendence-465e2.firebaseapp.com",
            projectId: "automated-attendence-465e2",
            storageBucket: "automated-attendence-465e2.firebasestorage.app",
            messagingSenderId: "790541780026",
            appId: "1:790541780026:web:1614028c0706b6f9766103"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseApp = app;
        window.firestoreDb = db;
        window.firestoreModules = { collection, addDoc, getDocs, query, where, updateDoc, deleteDoc, doc, setDoc, Timestamp, orderBy };
        
        console.log('Firebase initialized successfully!');
        
        // Trigger app initialization after Firebase is ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <script>
        // Global variables
        let currentUser = null;
        let students = [];
        let attendanceRecords = [];
        let settings = {
            schoolName: 'Government Primary School Rampur',
            attendanceStartTime: '09:00',
            attendanceEndTime: '09:30',
            schoolStartTime: '09:00',
            schoolEndTime: '15:30',
            confidenceThreshold: 0.6,
            processEveryNthFrame: 3,
            maxFaceDistance: 0.6,
            duplicatePreventionTime: 300000 // 5 minutes in milliseconds
        };
        let firebaseInitialized = false;
        let db = null;
        let firestoreModules = null;
        let currentStudentPhoto = null;
        let currentAttendancePhoto = null;
        
        // Face recognition variables - Simple pixel/histogram comparison
        let autoAttendanceRunning = false;
        let recognitionInterval = null;
        let frameCounter = 0;
        let studentFaceData = new Map(); // Store face histogram data
        let lastAttendanceMarked = new Map(); // Track last attendance time per student
        let capturedFacePhotos = [];
        let captureInProgress = false;
        let faceDetectionReady = true; // Always ready with canvas-based detection

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to initialize
            if (window.firestoreDb) {
                initializeApp();
            } else {
                window.addEventListener('firebase-ready', initializeApp);
            }
        });
        
        function initializeApp() {
            db = window.firestoreDb;
            firestoreModules = window.firestoreModules;
            firebaseInitialized = true;
            
            console.log('App initializing with Firebase...');
            
            loadData();
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(updateAttendanceWindow, 30000);
            
            // Set default dates for reports
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fromDate').value = today;
            document.getElementById('toDate').value = today;
            
            // Initialize canvas-based face recognition
            initializeFaceRecognition();
        }
        
        // Initialize canvas-based face recognition system
        function initializeFaceRecognition() {
            try {
                const modelLoading = document.getElementById('modelLoading');
                if (modelLoading) {
                    modelLoading.style.display = 'none';
                }
                
                // Load existing face data from memory
                loadStoredFaceData();
                
                console.log('Canvas-based face recognition system initialized successfully');
                return true;
            } catch (error) {
                console.error('Error initializing face recognition:', error);
                return false;
            }
        }
        
        // Load stored face data (histograms and features)
        function loadStoredFaceData() {
            students.forEach(student => {
                if (student.faceData && student.faceData.length > 0) {
                    studentFaceData.set(student.id, student.faceData);
                }
            });
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'password') {
                currentUser = username;
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('mainApp').classList.add('active');
                updateDashboard();
                loadStudentSelect();
            } else {
                showAlert('loginError', 'Invalid username or password', 'error');
            }
        });

        // Navigation
        function showPage(pageId) {
            // Hide all pages
            const pages = document.querySelectorAll('#mainApp .page');
            pages.forEach(page => page.classList.remove('active'));
            
            // Show selected page
            document.getElementById(pageId + 'Page').classList.add('active');
            
            // Update nav links
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            
            // Update specific page content
            if (pageId === 'students') {
                loadStudentsList();
            } else if (pageId === 'attendance') {
                loadTodayAttendance();
                updateAttendancePageWindow();
            } else if (pageId === 'reports') {
                // Load reports if needed
            } else if (pageId === 'settings') {
                loadSettings();
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.remove('active');
            document.getElementById('loginPage').classList.add('active');
            // Clear sensitive data
            stopAllCameras();
        }

        // Time and window management
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();
            
            const timeDisplay = document.getElementById('currentTime');
            if (timeDisplay) {
                timeDisplay.textContent = `${dateString} ${timeString}`;
            }
        }

        function updateAttendanceWindow() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const startParts = settings.attendanceStartTime.split(':');
            const endParts = settings.attendanceEndTime.split(':');
            const startTime = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
            const endTime = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
            
            const isOpen = currentTime >= startTime && currentTime <= endTime;
            
            const windowElement = document.getElementById('attendanceWindow');
            const statusElement = document.getElementById('windowStatus');
            
            if (windowElement && statusElement) {
                if (isOpen) {
                    windowElement.classList.remove('closed');
                    statusElement.textContent = `Attendance window is OPEN (${settings.attendanceStartTime} - ${settings.attendanceEndTime})`;
                } else {
                    windowElement.classList.add('closed');
                    if (currentTime < startTime) {
                        statusElement.textContent = `Attendance window opens at ${settings.attendanceStartTime}`;
                    } else {
                        statusElement.textContent = `Attendance window closed at ${settings.attendanceEndTime}`;
                    }
                }
            }
        }

        function updateAttendancePageWindow() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const startParts = settings.attendanceStartTime.split(':');
            const endParts = settings.attendanceEndTime.split(':');
            const startTime = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
            const endTime = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
            
            const isOpen = currentTime >= startTime && currentTime <= endTime;
            
            const windowElement = document.getElementById('attendancePageWindow');
            const statusElement = document.getElementById('attendancePageWindowStatus');
            
            if (windowElement && statusElement) {
                if (isOpen) {
                    windowElement.classList.remove('closed');
                    statusElement.textContent = `Window is OPEN - You can mark attendance now`;
                } else {
                    windowElement.classList.add('closed');
                    statusElement.textContent = `Window is CLOSED - Attendance marking disabled`;
                }
            }
        }

        // Firebase Firestore Data Management
        async function loadData() {
            try {
                console.log('Loading data from Firestore...');
                
                // Load students
                await fetchAllStudents();
                
                // Load attendance records
                await fetchAllAttendance();
                
                // Load settings
                await fetchSettings();
                
                console.log('Data loaded successfully from Firestore');
                updateDashboard();
                updateAttendanceWindow();
                loadStudentSelect();
                
            } catch (error) {
                console.error('Error loading data from Firestore:', error);
                alert('Error loading data from Firebase. Please check your internet connection.');
            }
        }

        async function saveData() {
            // Legacy function - now we save directly to Firestore in individual operations
            console.log('Data auto-saved to Firestore');
            return true;
        }

        // Firestore: Save student
        async function saveStudentToFirestore(student) {
            try {
                const { collection, addDoc, doc, setDoc } = firestoreModules;
                const studentsRef = collection(db, 'students');
                
                // Use student ID as document ID
                const studentDoc = doc(db, 'students', student.id);
                await setDoc(studentDoc, {
                    studentId: student.id,
                    name: student.name,
                    class: student.class,
                    rollNumber: student.rollNumber,
                    faceData: student.faceData || [],
                    photoUrl: student.photo || '',
                    registered: true,
                    registeredAt: firestoreModules.Timestamp.now(),
                    createdAt: student.createdAt || new Date().toISOString()
                });
                
                console.log('Student saved to Firestore:', student.id);
                return true;
            } catch (error) {
                console.error('Error saving student to Firestore:', error);
                throw error;
            }
        }

        // Firestore: Fetch all students
        async function fetchAllStudents() {
            try {
                const { collection, getDocs } = firestoreModules;
                const studentsRef = collection(db, 'students');
                const snapshot = await getDocs(studentsRef);
                
                students = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    students.push({
                        id: data.studentId || doc.id,
                        name: data.name,
                        class: data.class,
                        rollNumber: data.rollNumber,
                        photo: data.photoUrl,
                        faceData: data.faceData || [],
                        registered: data.registered || true,
                        createdAt: data.createdAt
                    });
                });
                
                console.log(`Loaded ${students.length} students from Firestore`);
                loadStoredFaceData();
                return students;
            } catch (error) {
                console.error('Error fetching students:', error);
                return [];
            }
        }

        // Firestore: Save attendance record
        async function saveAttendanceToFirestore(record) {
            try {
                const { collection, addDoc } = firestoreModules;
                const attendanceRef = collection(db, 'attendance');
                
                await addDoc(attendanceRef, {
                    studentId: record.studentId,
                    studentName: record.studentName,
                    date: record.date,
                    status: record.status,
                    loginTime: record.time,
                    logoutTime: record.logoutTime || '',
                    photo: record.photo || '',
                    confidence: record.confidence || 0,
                    method: record.method || 'manual',
                    timestamp: firestoreModules.Timestamp.now()
                });
                
                console.log('Attendance saved to Firestore:', record.studentId);
                return true;
            } catch (error) {
                console.error('Error saving attendance:', error);
                throw error;
            }
        }

        // Firestore: Fetch all attendance records
        async function fetchAllAttendance() {
            try {
                const { collection, getDocs } = firestoreModules;
                const attendanceRef = collection(db, 'attendance');
                const snapshot = await getDocs(attendanceRef);
                
                attendanceRecords = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    attendanceRecords.push({
                        id: doc.id,
                        studentId: data.studentId,
                        studentName: data.studentName,
                        date: data.date,
                        status: data.status,
                        time: data.loginTime || data.time,
                        photo: data.photo || '',
                        confidence: data.confidence || 0,
                        method: data.method || 'manual',
                        timestamp: data.timestamp
                    });
                });
                
                console.log(`Loaded ${attendanceRecords.length} attendance records from Firestore`);
                return attendanceRecords;
            } catch (error) {
                console.error('Error fetching attendance:', error);
                return [];
            }
        }

        // Firestore: Fetch attendance by date range
        async function fetchAttendanceByDate(fromDate, toDate) {
            try {
                const { collection, query, where, getDocs } = firestoreModules;
                const attendanceRef = collection(db, 'attendance');
                const q = query(
                    attendanceRef,
                    where('date', '>=', fromDate),
                    where('date', '<=', toDate)
                );
                
                const snapshot = await getDocs(q);
                const records = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    records.push({
                        id: doc.id,
                        studentId: data.studentId,
                        studentName: data.studentName,
                        date: data.date,
                        status: data.status,
                        time: data.loginTime || data.time,
                        photo: data.photo || '',
                        confidence: data.confidence || 0,
                        method: data.method || 'manual'
                    });
                });
                
                return records;
            } catch (error) {
                console.error('Error fetching attendance by date:', error);
                return [];
            }
        }

        // Firestore: Update settings
        async function updateSettings(newSettings) {
            try {
                const { doc, setDoc } = firestoreModules;
                
                // Save each setting as a separate document
                const settingsToSave = [
                    { name: 'schoolName', value: newSettings.schoolName },
                    { name: 'attendanceStartTime', value: newSettings.attendanceStartTime },
                    { name: 'attendanceEndTime', value: newSettings.attendanceEndTime },
                    { name: 'confidenceThreshold', value: newSettings.confidenceThreshold },
                    { name: 'processEveryNthFrame', value: newSettings.processEveryNthFrame }
                ];
                
                for (const setting of settingsToSave) {
                    const settingDoc = doc(db, 'settings', setting.name);
                    await setDoc(settingDoc, {
                        settingName: setting.name,
                        value: setting.value,
                        updatedAt: firestoreModules.Timestamp.now()
                    });
                }
                
                console.log('Settings updated in Firestore');
                return true;
            } catch (error) {
                console.error('Error updating settings:', error);
                throw error;
            }
        }

        // Firestore: Fetch settings
        async function fetchSettings() {
            try {
                const { collection, getDocs } = firestoreModules;
                const settingsRef = collection(db, 'settings');
                const snapshot = await getDocs(settingsRef);
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const settingName = data.settingName;
                    const value = data.value;
                    
                    if (settings.hasOwnProperty(settingName)) {
                        settings[settingName] = value;
                    }
                });
                
                console.log('Settings loaded from Firestore');
                return settings;
            } catch (error) {
                console.error('Error fetching settings:', error);
                return settings;
            }
        }

        // Firestore: Delete student
        async function deleteStudentFromFirestore(studentId) {
            try {
                const { doc, deleteDoc } = firestoreModules;
                const studentDoc = doc(db, 'students', studentId);
                await deleteDoc(studentDoc);
                console.log('Student deleted from Firestore:', studentId);
                return true;
            } catch (error) {
                console.error('Error deleting student:', error);
                throw error;
            }
        }

        // Student management
        function showAddStudent() {
            document.getElementById('addStudentForm').classList.remove('hidden');
            generateStudentId();
        }

        function cancelAddStudent() {
            document.getElementById('addStudentForm').classList.add('hidden');
            stopStudentCamera();
            clearStudentForm();
        }

        function generateStudentId() {
            const nextId = students.length + 1;
            document.getElementById('studentId').value = `STU${nextId.toString().padStart(3, '0')}`;
        }

        function clearStudentForm() {
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('rollNumber').value = '';
            currentStudentPhoto = null;
            capturedFacePhotos = [];
            document.getElementById('saveStudentBtn').disabled = true;
            document.getElementById('captureProgress').style.display = 'none';
        }

        function startStudentCamera() {
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 }, 
                    height: { ideal: 480 },
                    facingMode: 'user'
                } 
            })
                .then(stream => {
                    const video = document.getElementById('studentCamera');
                    video.srcObject = stream;
                    
                    // Start face detection overlay
                    video.addEventListener('play', () => {
                        startStudentFaceDetection();
                    });
                })
                .catch(error => {
                    console.error('Error accessing camera:', error);
                    showAlert('studentAlert', 'Error accessing camera. Please check permissions.', 'error');
                });
        }

        function stopStudentCamera() {
            const video = document.getElementById('studentCamera');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            captureInProgress = false;
        }

        function startStudentFaceDetection() {
            const video = document.getElementById('studentCamera');
            const overlay = document.getElementById('studentOverlay');
            const status = document.getElementById('studentRecognitionStatus');
            
            if (!video || !overlay) return;
            
            overlay.width = video.offsetWidth;
            overlay.height = video.offsetHeight;
            
            const detectFaces = () => {
                if (video.paused || video.ended || !video.srcObject) return;
                
                try {
                    const faceDetected = detectFaceInVideo(video);
                    const ctx = overlay.getContext('2d');
                    ctx.clearRect(0, 0, overlay.width, overlay.height);
                    
                    if (faceDetected) {
                        status.style.display = 'block';
                        status.textContent = 'Face detected - Ready for capture';
                        
                        // Draw face detection box
                        const centerX = video.offsetWidth / 2;
                        const centerY = video.offsetHeight / 2;
                        const boxSize = Math.min(video.offsetWidth, video.offsetHeight) * 0.4;
                        
                        ctx.strokeStyle = '#21808D';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(
                            centerX - boxSize/2, 
                            centerY - boxSize/2, 
                            boxSize, 
                            boxSize
                        );
                    } else {
                        status.style.display = 'block';
                        status.textContent = 'No face detected - Please position yourself in front of camera';
                    }
                } catch (error) {
                    console.error('Face detection error:', error);
                }
                
                requestAnimationFrame(detectFaces);
            };
            
            detectFaces();
        }

        async function captureMultipleFacePhotos() {
            if (captureInProgress) return;
            
            captureInProgress = true;
            capturedFacePhotos = [];
            
            const progress = document.getElementById('captureProgress');
            const countElement = document.getElementById('captureCount');
            const confidenceElement = document.getElementById('captureConfidence');
            
            progress.style.display = 'block';
            
            const video = document.getElementById('studentCamera');
            const canvas = document.getElementById('studentCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            for (let i = 0; i < 5; i++) {
                try {
                    // Wait between captures
                    if (i > 0) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    // Check if face is detected in current frame
                    if (!detectFaceInVideo(video)) {
                        showAlert('studentAlert', `No face detected in capture ${i + 1}. Please ensure your face is clearly visible.`, 'error');
                        captureInProgress = false;
                        progress.style.display = 'none';
                        return;
                    }
                    
                    // Capture photo and extract face data
                    context.drawImage(video, 0, 0);
                    const photoData = canvas.toDataURL('image/jpeg', 0.8);
                    const faceData = extractFaceData(canvas, video.videoWidth, video.videoHeight);
                    
                    if (faceData) {
                        capturedFacePhotos.push({
                            photo: photoData,
                            faceData: faceData
                        });
                        
                        countElement.textContent = i + 1;
                        confidenceElement.style.width = ((i + 1) / 5 * 100) + '%';
                        
                        // Use first photo as the display photo
                        if (i === 0) {
                            currentStudentPhoto = photoData;
                        }
                    } else {
                        showAlert('studentAlert', `Failed to extract face data in capture ${i + 1}. Please try again.`, 'error');
                        captureInProgress = false;
                        progress.style.display = 'none';
                        return;
                    }
                } catch (error) {
                    console.error('Error capturing face:', error);
                    showAlert('studentAlert', 'Error during face capture. Please try again.', 'error');
                    captureInProgress = false;
                    progress.style.display = 'none';
                    return;
                }
            }
            
            captureInProgress = false;
            progress.style.display = 'none';
            document.getElementById('saveStudentBtn').disabled = false;
            showAlert('studentAlert', 'Face data captured successfully! You can now save the student.', 'success');
        }

        async function saveStudent() {
            const id = document.getElementById('studentId').value.trim();
            const name = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value.trim();
            const rollNumber = document.getElementById('rollNumber').value.trim();
            
            if (!id || !name || !studentClass || !rollNumber) {
                showAlert('studentAlert', 'Please fill all fields', 'error');
                return;
            }
            
            if (!currentStudentPhoto || capturedFacePhotos.length === 0) {
                showAlert('studentAlert', 'Please capture face data using the "Capture Face Data" button', 'error');
                return;
            }
            
            // Check for duplicate ID
            if (students.find(s => s.id === id)) {
                showAlert('studentAlert', 'Student ID already exists', 'error');
                return;
            }
            
            // Store all captured face data for better matching
            const faceDataArray = capturedFacePhotos.map(item => item.faceData);
            
            const student = {
                id,
                name,
                class: studentClass,
                rollNumber,
                photo: currentStudentPhoto,
                faceData: faceDataArray,
                registered: true,
                createdAt: new Date().toISOString()
            };
            
            try {
                // Save to Firestore
                await saveStudentToFirestore(student);
                
                // Add to local array
                students.push(student);
                
                // Store face data in memory for recognition
                studentFaceData.set(id, faceDataArray);
                
                showAlert('studentAlert', 'Student saved successfully to Firebase!', 'success');
                setTimeout(() => {
                    cancelAddStudent();
                    loadStudentsList();
                    loadStudentSelect();
                    updateDashboard();
                }, 1000);
            } catch (error) {
                console.error('Error saving student:', error);
                showAlert('studentAlert', 'Error saving student to Firebase. Please try again.', 'error');
            }
        }
        
        // Canvas-based face detection using pixel analysis
        function detectFaceInVideo(video) {
            try {
                if (!video || video.videoWidth === 0) return false;
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 64; // Small size for fast processing
                canvas.height = 48;
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Simple face detection based on skin tone and brightness patterns
                let skinPixels = 0;
                let totalPixels = imageData.data.length / 4;
                
                for (let i = 0; i < imageData.data.length; i += 4) {
                    const r = imageData.data[i];
                    const g = imageData.data[i + 1];
                    const b = imageData.data[i + 2];
                    
                    // Simple skin tone detection
                    if (r > 95 && g > 40 && b > 20 && 
                        r > g && r > b && 
                        Math.abs(r - g) > 15 && 
                        r - b > 15) {
                        skinPixels++;
                    }
                }
                
                // If more than 8% of pixels are skin-toned, assume face is present
                return (skinPixels / totalPixels) > 0.08;
            } catch (error) {
                console.error('Face detection error:', error);
                return false;
            }
        }
        
        // Extract face data using histogram and features
        function extractFaceData(canvas, width, height) {
            try {
                const ctx = canvas.getContext('2d');
                
                // Extract center region (where face typically is)
                const centerX = width * 0.3;
                const centerY = height * 0.25;
                const regionWidth = width * 0.4;
                const regionHeight = height * 0.5;
                
                const imageData = ctx.getImageData(centerX, centerY, regionWidth, regionHeight);
                
                // Create color histogram
                const rHist = new Array(32).fill(0);
                const gHist = new Array(32).fill(0);
                const bHist = new Array(32).fill(0);
                
                // Extract basic features
                let totalR = 0, totalG = 0, totalB = 0;
                let pixelCount = 0;
                
                for (let i = 0; i < imageData.data.length; i += 4) {
                    const r = imageData.data[i];
                    const g = imageData.data[i + 1];
                    const b = imageData.data[i + 2];
                    
                    // Build histograms (8 bins per channel)
                    rHist[Math.floor(r / 8)]++;
                    gHist[Math.floor(g / 8)]++;
                    bHist[Math.floor(b / 8)]++;
                    
                    totalR += r;
                    totalG += g;
                    totalB += b;
                    pixelCount++;
                }
                
                // Normalize histograms
                const normalizeHist = (hist) => hist.map(val => val / pixelCount);
                
                return {
                    rHist: normalizeHist(rHist),
                    gHist: normalizeHist(gHist),
                    bHist: normalizeHist(bHist),
                    avgR: totalR / pixelCount,
                    avgG: totalG / pixelCount,
                    avgB: totalB / pixelCount,
                    width: regionWidth,
                    height: regionHeight
                };
            } catch (error) {
                console.error('Error extracting face data:', error);
                return null;
            }
        }
        
        // Compare two face data objects
        function compareFaceData(faceData1, faceData2, threshold = 0.7) {
            try {
                if (!faceData1 || !faceData2) return 0;
                
                // Compare color histograms using correlation
                const rCorr = calculateHistogramCorrelation(faceData1.rHist, faceData2.rHist);
                const gCorr = calculateHistogramCorrelation(faceData1.gHist, faceData2.gHist);
                const bCorr = calculateHistogramCorrelation(faceData1.bHist, faceData2.bHist);
                
                // Compare average colors
                const avgColorDiff = Math.sqrt(
                    Math.pow(faceData1.avgR - faceData2.avgR, 2) +
                    Math.pow(faceData1.avgG - faceData2.avgG, 2) +
                    Math.pow(faceData1.avgB - faceData2.avgB, 2)
                ) / (255 * Math.sqrt(3));
                
                const colorSimilarity = 1 - avgColorDiff;
                
                // Combine metrics
                const similarity = (rCorr + gCorr + bCorr + colorSimilarity) / 4;
                
                return Math.max(0, Math.min(1, similarity));
            } catch (error) {
                console.error('Error comparing face data:', error);
                return 0;
            }
        }
        
        // Calculate histogram correlation
        function calculateHistogramCorrelation(hist1, hist2) {
            try {
                const mean1 = hist1.reduce((a, b) => a + b) / hist1.length;
                const mean2 = hist2.reduce((a, b) => a + b) / hist2.length;
                
                let numerator = 0;
                let sum1Sq = 0;
                let sum2Sq = 0;
                
                for (let i = 0; i < hist1.length; i++) {
                    const diff1 = hist1[i] - mean1;
                    const diff2 = hist2[i] - mean2;
                    
                    numerator += diff1 * diff2;
                    sum1Sq += diff1 * diff1;
                    sum2Sq += diff2 * diff2;
                }
                
                const denominator = Math.sqrt(sum1Sq * sum2Sq);
                return denominator === 0 ? 0 : numerator / denominator;
            } catch (error) {
                console.error('Error calculating correlation:', error);
                return 0;
            }
        }

        function loadStudentsList() {
            const container = document.getElementById('studentsList');
            if (!container) return;
            
            if (students.length === 0) {
                container.innerHTML = '<p class="text-center">No students registered yet. Click "Add Student" to get started.</p>';
                return;
            }
            
            container.innerHTML = students.map(student => `
                <div class="student-card">
                    <img src="${student.photo}" alt="${student.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZjVmNWY1Ii8+Cjx0ZXh0IHg9IjQwIiB5PSI0NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OTk5OSI+Tm8gSW1hZ2U8L3RleHQ+Cjwvc3ZnPg=='">
                    <h4>${student.name}</h4>
                    <p><strong>ID:</strong> ${student.id}</p>
                    <p><strong>Class:</strong> ${student.class}</p>
                    <p><strong>Roll:</strong> ${student.rollNumber}</p>
                    <div class="flex gap-8">
                        <button class="btn btn--secondary btn--sm" onclick="editStudent('${student.id}')">Edit</button>
                        <button class="btn btn--danger btn--sm" onclick="deleteStudent('${student.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function loadStudentSelect() {
            const select = document.getElementById('studentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choose student...</option>' + 
                students.map(student => 
                    `<option value="${student.id}">${student.name} (${student.id})</option>`
                ).join('');
        }

        function editStudent(id) {
            // Implementation for editing student
            alert('Edit functionality would be implemented here');
        }

        async function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                try {
                    await deleteStudentFromFirestore(id);
                    students = students.filter(s => s.id !== id);
                    studentFaceData.delete(id);
                    loadStudentsList();
                    loadStudentSelect();
                    updateDashboard();
                    alert('Student deleted successfully from Firebase!');
                } catch (error) {
                    console.error('Error deleting student:', error);
                    alert('Error deleting student. Please try again.');
                }
            }
        }

        // Attendance marking
        function startAttendanceCamera() {
            try {
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                })
                .then(stream => {
                    const video = document.getElementById('attendanceCamera');
                    if (video) {
                        video.srcObject = stream;
                    }
                })
                .catch(error => {
                    console.error('Error accessing camera:', error);
                    alert('Error accessing camera. Please check permissions and try again.');
                });
            } catch (error) {
                console.error('Camera initialization error:', error);
                alert('Camera not available. Please check device compatibility.');
            }
        }

        function stopAttendanceCamera() {
            try {
                const video = document.getElementById('attendanceCamera');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
            } catch (error) {
                console.error('Error stopping camera:', error);
            }
        }

        function captureAttendancePhoto() {
            try {
                const video = document.getElementById('attendanceCamera');
                if (!video || !video.srcObject || video.videoWidth === 0) {
                    alert('Please start the camera first');
                    return;
                }
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                currentAttendancePhoto = canvas.toDataURL('image/jpeg', 0.8);
                
                // Show comparison if student is selected
                const selectedStudentId = document.getElementById('studentSelect').value;
                if (selectedStudentId) {
                    showPhotoComparison(selectedStudentId);
                } else {
                    alert('Photo captured! Please select a student to compare.');
                }
            } catch (error) {
                console.error('Error capturing photo:', error);
                alert('Error capturing photo. Please try again.');
            }
        }

        function showPhotoComparison(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student || !currentAttendancePhoto) return;
            
            document.getElementById('registeredPhoto').src = student.photo;
            document.getElementById('currentPhoto').src = currentAttendancePhoto;
            document.getElementById('comparisonContainer').style.display = 'flex';
        }

        document.getElementById('studentSelect').addEventListener('change', function() {
            const studentId = this.value;
            if (studentId && currentAttendancePhoto) {
                showPhotoComparison(studentId);
            } else {
                document.getElementById('comparisonContainer').style.display = 'none';
            }
        });

        function markPresent() {
            markAttendance('Present');
        }

        function markAbsent() {
            markAttendance('Absent');
        }

        async function markAttendance(status) {
            try {
                const selectedStudentId = document.getElementById('studentSelect').value;
                if (!selectedStudentId) {
                    alert('Please select a student');
                    return;
                }
                
                const student = students.find(s => s.id === selectedStudentId);
                if (!student) {
                    alert('Student not found');
                    return;
                }
                
                // Check attendance window
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                const startParts = settings.attendanceStartTime.split(':');
                const endParts = settings.attendanceEndTime.split(':');
                const startTime = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
                const endTime = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);
                
                if (currentTime < startTime || currentTime > endTime) {
                    if (!confirm('Attendance window is closed. Mark attendance anyway?')) {
                        return;
                    }
                }
                
                const today = new Date().toISOString().split('T')[0];
                
                // Check if already marked today
                const existingRecord = attendanceRecords.find(r => 
                    r.studentId === selectedStudentId && r.date === today
                );
                
                if (existingRecord) {
                    alert('Attendance already marked for this student today. Cannot update from manual entry.');
                    return;
                }
                
                const record = {
                    id: Date.now().toString(),
                    studentId: selectedStudentId,
                    studentName: student.name,
                    date: today,
                    status,
                    time: now.toLocaleTimeString(),
                    photo: currentAttendancePhoto,
                    timestamp: now.toISOString(),
                    method: 'manual'
                };
                
                // Save to Firestore
                await saveAttendanceToFirestore(record);
                
                // Add to local array
                attendanceRecords.push(record);
                
                alert(`Attendance marked as ${status} for ${student.name} - Saved to Firebase!`);
                
                // Reset form
                const studentSelect = document.getElementById('studentSelect');
                const comparisonContainer = document.getElementById('comparisonContainer');
                
                if (studentSelect) studentSelect.value = '';
                if (comparisonContainer) comparisonContainer.style.display = 'none';
                
                currentAttendancePhoto = null;
                
                loadTodayAttendance();
                updateDashboard();
                
            } catch (error) {
                console.error('Error marking attendance:', error);
                alert('Error marking attendance in Firebase. Please try again.');
            }
        }

        function loadTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = attendanceRecords.filter(r => r.date === today);
            
            const tbody = document.getElementById('todayAttendanceBody');
            if (!tbody) return;
            
            if (todayRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No attendance records for today</td></tr>';
                return;
            }
            
            tbody.innerHTML = todayRecords.map(record => `
                <tr>
                    <td>${record.studentId}</td>
                    <td>${record.studentName}</td>
                    <td><span class="status status--${record.status.toLowerCase() === 'present' ? 'success' : 'error'}">${record.status}</span></td>
                    <td>${record.time}</td>
                </tr>
            `).join('');
        }

        // Dashboard updates
        function updateDashboard() {
            const totalStudents = students.length;
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = attendanceRecords.filter(r => r.date === today);
            const presentToday = todayRecords.filter(r => r.status === 'Present').length;
            const absentToday = todayRecords.filter(r => r.status === 'Absent').length;
            const attendanceRate = totalStudents > 0 ? Math.round((presentToday / totalStudents) * 100) : 0;
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('presentToday').textContent = presentToday;
            document.getElementById('absentToday').textContent = absentToday;
            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            
            // Update settings page stats
            document.getElementById('settingsTotalStudents').textContent = totalStudents;
            document.getElementById('totalAttendanceRecords').textContent = attendanceRecords.length;
            
            // Today's summary
            const summaryElement = document.getElementById('todaySummary');
            if (summaryElement) {
                summaryElement.innerHTML = `
                    <p><strong>Total Students:</strong> ${totalStudents}</p>
                    <p><strong>Present:</strong> ${presentToday}</p>
                    <p><strong>Absent:</strong> ${absentToday}</p>
                    <p><strong>Not Marked:</strong> ${totalStudents - presentToday - absentToday}</p>
                    <p><strong>Attendance Rate:</strong> ${attendanceRate}%</p>
                `;
            }
        }

        // Settings management
        function loadSettings() {
            document.getElementById('schoolName').value = settings.schoolName;
            document.getElementById('attendanceStartTime').value = settings.attendanceStartTime;
            document.getElementById('attendanceEndTime').value = settings.attendanceEndTime;
        }

        async function saveSchoolSettings() {
            settings.schoolName = document.getElementById('schoolName').value;
            try {
                await updateSettings(settings);
                alert('School settings saved successfully to Firebase!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings. Please try again.');
            }
        }

        async function saveTimeSettings() {
            settings.attendanceStartTime = document.getElementById('attendanceStartTime').value;
            settings.attendanceEndTime = document.getElementById('attendanceEndTime').value;
            try {
                await updateSettings(settings);
                updateAttendanceWindow();
                updateAttendancePageWindow();
                alert('Time settings saved successfully to Firebase!');
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error saving settings. Please try again.');
            }
        }

        // Reports and export
        async function generateReport() {
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            if (!fromDate || !toDate) {
                alert('Please select both from and to dates');
                return;
            }
            
            try {
                // Fetch fresh data from Firestore for the date range
                const filteredRecords = await fetchAttendanceByDate(fromDate, toDate);
                displayReport(filteredRecords, fromDate, toDate);
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Error generating report. Please try again.');
            }
        }

        function displayReport(records, fromDate, toDate) {
            const totalPresent = records.filter(r => r.status === 'Present').length;
            const totalAbsent = records.filter(r => r.status === 'Absent').length;
            const totalRecords = records.length;
            const attendanceRate = totalRecords > 0 ? Math.round((totalPresent / totalRecords) * 100) : 0;
            
            // Calculate unique days
            const uniqueDates = [...new Set(records.map(r => r.date))];
            const totalDays = uniqueDates.length;
            
            // Update summary stats
            document.getElementById('reportTotalDays').textContent = totalDays;
            document.getElementById('reportTotalPresent').textContent = totalPresent;
            document.getElementById('reportTotalAbsent').textContent = totalAbsent;
            document.getElementById('reportAttendanceRate').textContent = attendanceRate + '%';
            
            // Create detailed table
            const container = document.getElementById('reportTableContainer');
            if (records.length === 0) {
                container.innerHTML = '<p class="text-center">No attendance records found for the selected date range.</p>';
                return;
            }
            
            const table = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => `
                            <tr>
                                <td>${record.date}</td>
                                <td>${record.studentId}</td>
                                <td>${record.studentName}</td>
                                <td><span class="status status--${record.status.toLowerCase() === 'present' ? 'success' : 'error'}">${record.status}</span></td>
                                <td>${record.time}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        function exportToCSV() {
            try {
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                
                if (!fromDate || !toDate) {
                    alert('Please select both from and to dates and generate report first');
                    return;
                }
                
                const filteredRecords = attendanceRecords.filter(record => {
                    return record.date >= fromDate && record.date <= toDate;
                });
                
                if (filteredRecords.length === 0) {
                    alert('No data to export for selected date range');
                    return;
                }
                
                // Create CSV content with proper escaping
                const headers = ['Date', 'Student_ID', 'Name', 'Class', 'Roll_Number', 'Status', 'Time', 'Method', 'Confidence'];
                let csvContent = headers.join(',') + '\n';
                
                filteredRecords.forEach(record => {
                    const student = students.find(s => s.id === record.studentId);
                    const row = [
                        record.date,
                        record.studentId,
                        `"${record.studentName.replace(/"/g, '""')}"`, // Escape quotes
                        student ? `"${student.class.replace(/"/g, '""')}"` : '""',
                        student ? `"${student.rollNumber.replace(/"/g, '""')}"` : '""',
                        record.status,
                        record.time,
                        record.method || 'manual',
                        record.confidence ? Math.round(record.confidence * 100) + '%' : 'N/A'
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // Add summary at the end
                csvContent += '\n--- SUMMARY ---\n';
                csvContent += `Total Records,${filteredRecords.length}\n`;
                csvContent += `Present,${filteredRecords.filter(r => r.status === 'Present').length}\n`;
                csvContent += `Absent,${filteredRecords.filter(r => r.status === 'Absent').length}\n`;
                csvContent += `Auto Recognized,${filteredRecords.filter(r => r.method === 'auto_face_recognition').length}\n`;
                csvContent += `Manual Entry,${filteredRecords.filter(r => r.method === 'manual').length}\n`;
                csvContent += `Date Range,${fromDate} to ${toDate}\n`;
                csvContent += `Generated On,${new Date().toISOString()}\n`;
                csvContent += `School,${settings.schoolName}\n`;
                
                // Download file
                try {
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `attendance_report_${fromDate}_${toDate}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    alert('Report exported successfully!');
                } catch (downloadError) {
                    console.error('Download error:', downloadError);
                    // Fallback: show CSV content in a new window
                    const newWindow = window.open();
                    newWindow.document.write('<pre>' + csvContent + '</pre>');
                    newWindow.document.title = 'Attendance Report CSV';
                    alert('Report generated! Please copy the content from the new window.');
                }
                
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting report. Please try again.');
            }
        }

        // Data management functions
        function backupData() {
            const backupData = {
                students,
                attendanceRecords,
                settings,
                backupDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `attendance_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            // Update last backup time
            setInStorage('lastBackup', new Date().toISOString());
            document.getElementById('lastBackup').textContent = new Date().toLocaleDateString();
            
            alert('Data backed up successfully!');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (confirm('This will replace all current data. Are you sure?')) {
                        if (importedData.students) students = importedData.students;
                        if (importedData.attendanceRecords) attendanceRecords = importedData.attendanceRecords;
                        if (importedData.settings) settings = { ...settings, ...importedData.settings };
                        
                        saveData();
                        updateDashboard();
                        loadStudentsList();
                        loadStudentSelect();
                        loadSettings();
                        
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            alert('Data clearing from Firebase is disabled for safety. Please use Firebase Console to delete collections if needed.');
        }

        // Utility functions
        function showAlert(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = message;
            element.className = `alert alert--${type}`;
            element.classList.remove('hidden');
            
            setTimeout(() => {
                if (element) {
                    element.classList.add('hidden');
                }
            }, 5000);
        }

        function stopAllCameras() {
            try {
                stopStudentCamera();
                stopAttendanceCamera();
                if (autoAttendanceRunning) {
                    stopAutoAttendance();
                }
            } catch (error) {
                console.error('Error stopping cameras:', error);
            }
        }
        
        // Load default students for demo/testing purposes
        function loadDefaultStudents() {
            const defaultStudents = [
                {
                    id: "STU001",
                    name: "Rahul Kumar",
                    class: "5th", 
                    rollNumber: "05",
                    photo: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjZjBmNGY4Ii8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNDUiIHI9IjIwIiBmaWxsPSIjY2JkNWUwIi8+CjxwYXRoIGQ9Im0zMCA4MCAzMC0xMCAzMCAxMHYyMGgtNjB6IiBmaWxsPSIjY2JkNWUwIi8+Cjx0ZXh0IHg9IjYwIiB5PSIxMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM2YjczODAiIGZvbnQtc2l6ZT0iMTAiPkRlZmF1bHQgVXNlcjwvdGV4dD4KPC9zdmc+",
                    faceData: [], 
                    registered: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: "STU002",
                    name: "Priya Sharma",
                    class: "6th",
                    rollNumber: "12",
                    photo: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjZmVmM2Y0Ii8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNDUiIHI9IjIwIiBmaWxsPSIjZjNlOGZmIi8+CjxwYXRoIGQ9Im0zMCA4MCAzMC0xMCAzMCAxMHYyMGgtNjB6IiBmaWxsPSIjZjNlOGZmIi8+Cjx0ZXh0IHg9IjYwIiB5PSIxMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNhYzY4ZmYiIGZvbnQtc2l6ZT0iMTAiPkRlZmF1bHQgVXNlcjwvdGV4dD4KPC9zdmc+",
                    faceData: [],
                    registered: true,
                    createdAt: new Date().toISOString()
                },
                {
                    id: "STU003",
                    name: "Amit Singh",
                    class: "5th",
                    rollNumber: "08", 
                    photo: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSIjZjBmZGY0Ii8+CjxjaXJjbGUgY3g9IjYwIiBjeT0iNDUiIHI9IjIwIiBmaWxsPSIjZGNmY2U3Ii8+CjxwYXRoIGQ9Im0zMCA4MCAzMC0xMCAzMCAxMHYyMGgtNjB6IiBmaWxsPSIjZGNmY2U3Ii8+Cjx0ZXh0IHg9IjYwIiB5PSIxMTAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiMyMmM1NWUiIGZvbnQtc2l6ZT0iMTAiPkRlZmF1bHQgVXNlcjwvdGV4dD4KPC9zdmc+",
                    faceData: [],
                    registered: true,
                    createdAt: new Date().toISOString()
                }
            ];
            
            students = defaultStudents;
            saveData();
            updateDashboard();
            loadStudentSelect();
            console.log('Default students loaded for demo purposes');
        }

        // Auto-attendance functions - BULLETPROOF IMPLEMENTATION
        function startAutoAttendance() {
            try {
                if (autoAttendanceRunning) return;
                
                const video = document.getElementById('attendanceCamera');
                const startBtn = document.getElementById('startAutoBtn');
                const stopBtn = document.getElementById('stopAutoBtn');
                const status = document.getElementById('scanningStatus');
                
                if (!video) {
                    alert('Camera not available. Please ensure camera access is granted.');
                    return;
                }
                
                // Start camera
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 }, 
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                })
                .then(stream => {
                    video.srcObject = stream;
                    autoAttendanceRunning = true;
                    
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    
                    status.className = 'status-indicator scanning pulse';
                    status.innerHTML = '<span>‚óè</span> Scanning for Faces';
                    
                    // Start recognition loop
                    recognitionInterval = setInterval(processAutoAttendance, 2000);
                    
                    addToRecognitionLog('‚úì Auto attendance started successfully', 'success');
                })
                .catch(error => {
                    console.error('Camera access error:', error);
                    alert('Unable to access camera. Please check permissions and try again.');
                });
                
            } catch (error) {
                console.error('Error starting auto attendance:', error);
                alert('Error starting auto attendance. Please refresh and try again.');
            }
        }
        
        function stopAutoAttendance() {
            try {
                const video = document.getElementById('attendanceCamera');
                const startBtn = document.getElementById('startAutoBtn');
                const stopBtn = document.getElementById('stopAutoBtn');
                const status = document.getElementById('scanningStatus');
                
                autoAttendanceRunning = false;
                
                if (recognitionInterval) {
                    clearInterval(recognitionInterval);
                    recognitionInterval = null;
                }
                
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                
                if (startBtn) startBtn.disabled = false;
                if (stopBtn) stopBtn.disabled = true;
                
                if (status) {
                    status.className = 'status-indicator stopped';
                    status.innerHTML = '<span>‚óè</span> System Stopped';
                }
                
                addToRecognitionLog('‚ñ† Auto attendance stopped', 'info');
                
            } catch (error) {
                console.error('Error stopping auto attendance:', error);
            }
        }
        
        function processAutoAttendance() {
            try {
                if (!autoAttendanceRunning) return;
                
                const video = document.getElementById('attendanceCamera');
                if (!video || !video.srcObject || video.videoWidth === 0) return;
                
                // Check if face is detected
                if (!detectFaceInVideo(video)) {
                    return; // No face detected, continue scanning
                }
                
                // Extract face data from current frame
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                ctx.drawImage(video, 0, 0);
                const currentFaceData = extractFaceData(canvas, video.videoWidth, video.videoHeight);
                
                if (!currentFaceData) return;
                
                // Find best match among registered students
                let bestMatch = null;
                let bestSimilarity = 0;
                const threshold = parseFloat(document.getElementById('confidenceSlider').value);
                
                students.forEach(student => {
                    if (!student.faceData || student.faceData.length === 0) return;
                    
                    // Compare with all stored face data for this student
                    let maxSimilarity = 0;
                    student.faceData.forEach(storedFaceData => {
                        const similarity = compareFaceData(currentFaceData, storedFaceData);
                        maxSimilarity = Math.max(maxSimilarity, similarity);
                    });
                    
                    if (maxSimilarity > bestSimilarity && maxSimilarity >= threshold) {
                        bestSimilarity = maxSimilarity;
                        bestMatch = student;
                    }
                });
                
                if (bestMatch) {
                    // Check duplicate prevention
                    const now = Date.now();
                    const lastMarked = lastAttendanceMarked.get(bestMatch.id);
                    
                    if (!lastMarked || (now - lastMarked) > settings.duplicatePreventionTime) {
                        markAttendanceAutomatically(bestMatch, bestSimilarity, canvas.toDataURL('image/jpeg', 0.8));
                        lastAttendanceMarked.set(bestMatch.id, now);
                    }
                } else {
                    addToRecognitionLog('? Unknown face detected', 'warning');
                }
                
            } catch (error) {
                console.error('Error in auto attendance processing:', error);
                addToRecognitionLog('‚ö† Processing error occurred', 'error');
            }
        }
        
        async function markAttendanceAutomatically(student, confidence, photo) {
            try {
                const today = new Date().toISOString().split('T')[0];
                const now = new Date();
                
                // Check if already marked today
                const existingRecord = attendanceRecords.find(r => 
                    r.studentId === student.id && r.date === today
                );
                
                if (existingRecord) {
                    addToRecognitionLog(`${student.name} already marked today`, 'info');
                    return;
                }
                
                // Create attendance record
                const record = {
                    id: Date.now().toString(),
                    studentId: student.id,
                    studentName: student.name,
                    date: today,
                    status: 'Present',
                    time: now.toLocaleTimeString(),
                    photo: photo,
                    timestamp: now.toISOString(),
                    confidence: confidence,
                    method: 'auto_face_recognition'
                };
                
                // Save to Firestore
                await saveAttendanceToFirestore(record);
                
                // Add to local array
                attendanceRecords.push(record);
                
                // Show success notification
                showAttendanceSuccess(student.name, confidence);
                
                // Update displays
                loadTodayAttendance();
                updateDashboard();
                
                addToRecognitionLog(`‚úì ${student.name} marked present (${Math.round(confidence * 100)}%) - Saved to Firebase`, 'success');
                
            } catch (error) {
                console.error('Error marking automatic attendance:', error);
                addToRecognitionLog('‚ö† Error saving to Firebase', 'error');
            }
        }
        
        function updateConfidenceThreshold() {
            const slider = document.getElementById('confidenceSlider');
            const valueDisplay = document.getElementById('confidenceValue');
            if (slider && valueDisplay) {
                valueDisplay.textContent = slider.value;
                settings.confidenceThreshold = parseFloat(slider.value);
                saveData();
            }
        }
        
        function updateProcessingSpeed() {
            const speedSelect = document.getElementById('processingSpeed');
            if (speedSelect) {
                settings.processEveryNthFrame = parseInt(speedSelect.value);
                saveData();
            }
        }
        
        function addToRecognitionLog(message, type = 'info') {
            try {
                const logContainer = document.getElementById('recognitionLog');
                if (!logContainer) return;
                
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '4px';
                logEntry.style.padding = '4px';
                logEntry.style.fontSize = '12px';
                logEntry.style.borderRadius = '4px';
                
                // Color coding based on type
                switch (type) {
                    case 'success':
                        logEntry.style.backgroundColor = 'rgba(33, 128, 141, 0.1)';
                        logEntry.style.color = 'var(--color-success)';
                        break;
                    case 'error':
                        logEntry.style.backgroundColor = 'rgba(192, 21, 47, 0.1)';
                        logEntry.style.color = 'var(--color-error)';
                        break;
                    case 'warning':
                        logEntry.style.backgroundColor = 'rgba(168, 75, 47, 0.1)';
                        logEntry.style.color = 'var(--color-warning)';
                        break;
                    default:
                        logEntry.style.backgroundColor = 'rgba(98, 108, 113, 0.1)';
                        logEntry.style.color = 'var(--color-info)';
                }
                
                logEntry.innerHTML = `<strong>${timestamp}</strong> - ${message}`;
                
                // Add to top of log
                logContainer.insertBefore(logEntry, logContainer.firstChild);
                
                // Keep only last 10 entries
                while (logContainer.children.length > 10) {
                    logContainer.removeChild(logContainer.lastChild);
                }
                
            } catch (error) {
                console.error('Error adding to recognition log:', error);
            }
        }
        
        function showAttendanceSuccess(studentName, confidence) {
            try {
                const successOverlay = document.getElementById('attendanceSuccess');
                const successMessage = document.getElementById('successMessage');
                const successStudent = document.getElementById('successStudent');
                
                if (!successOverlay) return;
                
                if (successMessage) successMessage.textContent = 'Attendance Marked Successfully!';
                if (successStudent) successStudent.textContent = `${studentName} (${Math.round(confidence * 100)}% match)`;
                
                successOverlay.classList.add('show');
                
                setTimeout(() => {
                    successOverlay.classList.remove('show');
                }, 3000);
                
            } catch (error) {
                console.error('Error showing success notification:', error);
            }
        }
        
        // Initialize last backup display
        window.addEventListener('load', function() {
            try {
                const lastBackup = getFromStorage('lastBackup');
                const lastBackupEl = document.getElementById('lastBackup');
                if (lastBackup && lastBackupEl) {
                    lastBackupEl.textContent = new Date(lastBackup).toLocaleDateString();
                }
            } catch (error) {
                console.error('Error loading last backup info:', error);
            }
        });
    </script>
</body>
</html>